<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMSDv2</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/icon.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- chart.js -->
    <script src="{{ url_for('static', filename='node_modules/chart.js/dist/chart.umd.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>

    <main>
        <!-- nav -->
        <div class="left_box">
            <div class="total">


                <div id="allNav" class="active">
                    <div class="left">
                        <p class="title">All</p>
                        <p class="price">26 codes</p>
                        <p class="maxdate">15/11/2025</p>
                    </div>
                    <div class="right">
                        <svg class="allNav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                            <path
                                d="M384 160c-17.7 0-32-14.3-32-32s14.3-32 32-32l160 0c17.7 0 32 14.3 32 32l0 160c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-82.7L342.6 374.6c-12.5 12.5-32.8 12.5-45.3 0L192 269.3 54.6 406.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160c12.5-12.5 32.8-12.5 45.3 0L320 306.7 466.7 160 384 160z" />
                        </svg>
                    </div>
                </div>

                <div id="rubyNav">
                    <div class="left">
                        <p class="title">Ruby Value</p>
                        <p class="price">17000 R</p>
                        <p class="maxdate">18/02/2025</p>
                    </div>
                    <div class="right">
                        <svg class="ruby" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <path
                                d="M116.7 33.8c4.5-6.1 11.7-9.8 19.3-9.8l240 0c7.6 0 14.8 3.6 19.3 9.8l112 152c6.8 9.2 6.1 21.9-1.5 30.4l-232 256c-4.5 5-11 7.9-17.8 7.9s-13.2-2.9-17.8-7.9l-232-256c-7.7-8.5-8.3-21.2-1.5-30.4l112-152zm38.5 39.8c-3.3 2.5-4.2 7-2.1 10.5l57.4 95.6L63.3 192c-4.1 .3-7.3 3.8-7.3 8s3.2 7.6 7.3 8l192 16c.4 0 .9 0 1.3 0l192-16c4.1-.3 7.3-3.8 7.3-8s-3.2-7.6-7.3-8L301.5 179.8l57.4-95.6c2.1-3.5 1.2-8.1-2.1-10.5s-7.9-2-10.7 1L256 172.2 165.9 74.6c-2.8-3-7.4-3.4-10.7-1z" />
                        </svg>
                    </div>
                </div>

                <div id="staminaNav">
                    <div class="left">
                        <p class="title">Stamina Value</p>
                        <p class="price">30000 STM</p>
                        <p class="maxdate">15/11/2025</p>
                    </div>
                    <div class="right">
                        <svg class="stamina" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                            <path
                                d="M349.4 44.6c5.9-13.7 1.5-29.7-10.6-38.5s-28.6-8-39.9 1.8l-256 224c-10 8.8-13.6 22.9-8.9 35.3S50.7 288 64 288l111.5 0L98.6 467.4c-5.9 13.7-1.5 29.7 10.6 38.5s28.6 8 39.9-1.8l256-224c10-8.8 13.6-22.9 8.9-35.3s-16.6-20.7-30-20.7l-111.5 0L349.4 44.6z" />
                        </svg>
                    </div>
                </div>

                <div id="specialNav">
                    <div class="left">
                        <p class="title">Special Item</p>
                        <p class="price">6 objects</p>
                        <p class="maxdate">24/12/2024</p>
                    </div>
                    <div class="right">
                        <svg class="special" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                            <path
                                d="M64 64C28.7 64 0 92.7 0 128l0 64c0 8.8 7.4 15.7 15.7 18.6C34.5 217.1 48 235 48 256s-13.5 38.9-32.3 45.4C7.4 304.3 0 311.2 0 320l0 64c0 35.3 28.7 64 64 64l448 0c35.3 0 64-28.7 64-64l0-64c0-8.8-7.4-15.7-15.7-18.6C541.5 294.9 528 277 528 256s13.5-38.9 32.3-45.4c8.3-2.9 15.7-9.8 15.7-18.6l0-64c0-35.3-28.7-64-64-64L64 64zm64 112l0 160c0 8.8 7.2 16 16 16l288 0c8.8 0 16-7.2 16-16l0-160c0-8.8-7.2-16-16-16l-288 0c-8.8 0-16 7.2-16 16zM96 160c0-17.7 14.3-32 32-32l320 0c17.7 0 32 14.3 32 32l0 192c0 17.7-14.3 32-32 32l-320 0c-17.7 0-32-14.3-32-32l0-192z" />
                        </svg>
                    </div>
                </div>

            </div>

            <div class="graph">
                <canvas class="graphic"></canvas>
            </div>
            <script>
                // Données JSON
                let jsonData = '{{data | tojson | safe}}';
                jsonData = JSON.parse(jsonData);

                console.log(jsonData);

                // Obtenir la date d'aujourd'hui (en format ISO)
                const today = new Date();

                // Filtrer les données pour ne garder que celles dont la date d'expiration est supérieure ou égale à aujourd'hui
                const futureData = jsonData.filter(item => new Date(item.expiration) >= today);

                // Séparer les données filtrées en fonction du type de récompense
                const rubyData = futureData.filter(item => item.reward.type === 'Ruby');
                const staminaData = futureData.filter(item => item.reward.type === 'Stamina');
                const otherData = futureData.filter(item => !item.reward.type || item.reward.type === '');

                // Fonction pour convertir les dates en format 'yyyy-mm-dd'
                const formatDate = (date) => {
                    const d = new Date(date);
                    return d.toISOString().split('T')[0]; // 'yyyy-mm-dd'
                };

                // Extraire les labels (dates d'expiration) et compter le nombre de codes pour chaque type de récompense
                const rubyLabels = rubyData.map(item => formatDate(item.expiration));
                const rubyCount = rubyLabels.reduce((acc, date) => {
                    acc[date] = (acc[date] || 0) + 1;
                    return acc;
                }, {});

                const staminaLabels = staminaData.map(item => formatDate(item.expiration));
                const staminaCount = staminaLabels.reduce((acc, date) => {
                    acc[date] = (acc[date] || 0) + 1;
                    return acc;
                }, {});

                const otherLabels = otherData.map(item => formatDate(item.expiration));
                const otherCount = otherLabels.reduce((acc, date) => {
                    acc[date] = (acc[date] || 0) + 1;
                    return acc;
                }, {});

                // Fusionner les labels de toutes les catégories et éliminer les doublons
                const allLabels = [...new Set([...rubyLabels, ...staminaLabels, ...otherLabels])];

                // Trier les labels par date (ordre croissant)
                allLabels.sort((a, b) => new Date(a) - new Date(b));

                // Préparer les valeurs pour chaque date
                const rubyDataset = allLabels.map(label => rubyCount[label] || 0);
                const staminaDataset = allLabels.map(label => staminaCount[label] || 0);
                const otherDataset = allLabels.map(label => otherCount[label] || 0);

                const ctx = document.querySelector('.graphic').getContext('2d');

                // Créer le dégradé
                const RubyGradient = ctx.createLinearGradient(0, 0, 0, 400); // (x1, y1, x2, y2) — verticalement du haut vers le bas
                RubyGradient.addColorStop(0, 'rgba(242, 154, 156, 1)');  // Couleur au début du dégradé
                RubyGradient.addColorStop(.9, 'rgba(242, 154, 156, 0)');  // Couleur à la fin du dégradé

                const StaminaGradient = ctx.createLinearGradient(0, 0, 0, 400);
                StaminaGradient.addColorStop(0, 'rgba(236, 210, 58, 1)');
                StaminaGradient.addColorStop(.9, 'rgba(236, 210, 58, 0)');

                const OtherGradient = ctx.createLinearGradient(0, 0, 0, 400);
                OtherGradient.addColorStop(0, 'rgba(138, 54, 206, 1)');
                OtherGradient.addColorStop(.9, 'rgba(138, 54, 206, 0)');

                // Créer le graphique avec un design amélioré
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allLabels, // Les dates uniques triées
                        datasets: [
                            {
                                label: 'Ruby Rewards',
                                data: rubyDataset,
                                borderColor: 'rgb(242, 154, 156)', // Rouge pour Ruby
                                backgroundColor: RubyGradient, // Ombre légère sous la ligne
                                borderWidth: 3,
                                pointRadius: 6, // Plus gros points
                                pointBackgroundColor: 'rgb(242, 154, 156)',
                                pointBorderColor: '#fff', // Bordure blanche autour des points
                                pointBorderWidth: 1,
                                fill: true,
                                lineTension: 0.4, // Lignes arrondies
                                cubicInterpolationMode: 'monotone' // Courbes douces
                            },
                            {
                                label: 'Stamina Rewards',
                                data: staminaDataset,
                                borderColor: 'rgba(236, 210, 58, 1)', // Jaune pour Stamina
                                backgroundColor: StaminaGradient, // Ombre légère sous la ligne
                                borderWidth: 3,
                                pointRadius: 6,
                                pointBackgroundColor: 'rgba(236, 210, 58, 1)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                fill: true,
                                lineTension: 0.4,
                                cubicInterpolationMode: 'monotone'
                            },
                            {
                                label: 'Other Rewards',
                                data: otherDataset,
                                borderColor: 'rgba(138, 54, 206, 1)', // Violet pour les autres
                                backgroundColor: OtherGradient, // Ombre légère sous la ligne
                                borderWidth: 3,
                                pointRadius: 6,
                                pointBackgroundColor: 'rgba(138, 54, 206, 1)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                fill: true,
                                lineTension: 0.4,
                                cubicInterpolationMode: 'monotone'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Permet un ajustement automatique du graphique
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day', // Affichage par jour
                                    tooltipFormat: 'yyyy-MM-dd', // Format de la date
                                },
                                grid: {
                                    display: true, // Afficher la grille
                                    color: 'rgba(109, 125, 165, 0.2)', // Couleur de la grille (transparente ici)
                                    lineWidth: 1, // Épaisseur des lignes de la grille
                                    tickLength: 10,
                                },
                                title: {
                                    display: true,
                                    text: 'Expiration Date',
                                    font: {
                                        size: 16,
                                        weight: 'bold',
                                    }
                                },
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 20, // Limiter le nombre de dates affichées
                                    font: {
                                        size: 12, // Taille de la police des ticks
                                        weight: 'normal',
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Codes',
                                    font: {
                                        size: 16,
                                        weight: 'bold',
                                    }
                                },
                                grid: {
                                    display: true, // Afficher la grille
                                    color: 'rgba(109, 125, 165, 0.2)', // Couleur de la grille (transparente ici)
                                    lineWidth: 1, // Épaisseur des lignes de la grille
                                    tickLength: 10,
                                },
                                ticks: {
                                    font: {
                                        size: 12, // Taille de la police des ticks
                                        weight: 'normal',
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: 'rgba(26, 27, 44, 0.7)', // Fond sombre semi-transparent
                                titleColor: '#fff', // Couleur du titre du tooltip
                                bodyColor: '#fff', // Couleur du texte dans le tooltip
                                cornerRadius: 8, // Coins arrondis
                                padding: 12, // Espacement intérieur
                                devicePixelRatio: 4,
                                font: {
                                    size: 16, // Taille du texte
                                    weight: 'bold', // Poids du texte
                                },
                                callbacks: {
                                    // Tu peux aussi personnaliser ici les callbacks pour personnaliser davantage le tooltip si nécessaire.
                                },
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12, // Taille des labels de la légende
                                        weight: 'bold',
                                    }
                                }
                            }
                        }
                    }
                });
            </script>


            <!-- <p>
                {{data}}
            </p> -->
        </div>












        <div class="right_box">

            <div class="totalNumber">
                <p><span id="totalCoupons">X</span> Codes</p>
            </div>

            <div class="btnlist">
                <div class="github">
                    <a href="https://github.com/kerogs/SMSDv2" target="_blank"></a>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
                        <path
                            d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" />
                    </svg>
                </div>
                <div class="reddit">
                    <a href="https://www.reddit.com/r/SwordMaster_Story/" target="_blank"></a>
                    <svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 512 512">
                        <path
                            d="M373 138.6c-25.2 0-46.3-17.5-51.9-41l0 0c-30.6 4.3-54.2 30.7-54.2 62.4l0 .2c47.4 1.8 90.6 15.1 124.9 36.3c12.6-9.7 28.4-15.5 45.5-15.5c41.3 0 74.7 33.4 74.7 74.7c0 29.8-17.4 55.5-42.7 67.5c-2.4 86.8-97 156.6-213.2 156.6S45.5 410.1 43 323.4C17.6 311.5 0 285.7 0 255.7c0-41.3 33.4-74.7 74.7-74.7c17.2 0 33 5.8 45.7 15.6c34-21.1 76.8-34.4 123.7-36.4l0-.3c0-44.3 33.7-80.9 76.8-85.5C325.8 50.2 347.2 32 373 32c29.4 0 53.3 23.9 53.3 53.3s-23.9 53.3-53.3 53.3zM157.5 255.3c-20.9 0-38.9 20.8-40.2 47.9s17.1 38.1 38 38.1s36.6-9.8 37.8-36.9s-14.7-49.1-35.7-49.1zM395 303.1c-1.2-27.1-19.2-47.9-40.2-47.9s-36.9 22-35.7 49.1c1.2 27.1 16.9 36.9 37.8 36.9s39.3-11 38-38.1zm-60.1 70.8c1.5-3.6-1-7.7-4.9-8.1c-23-2.3-47.9-3.6-73.8-3.6s-50.8 1.3-73.8 3.6c-3.9 .4-6.4 4.5-4.9 8.1c12.9 30.8 43.3 52.4 78.7 52.4s65.8-21.6 78.7-52.4z" />
                    </svg>
                </div>
            </div>

        </div>
    </main>

</body>

<script>
    let AllCoupons = '{{data | tojson | safe}}';
    AllCoupons = JSON.parse(AllCoupons);

    // count all and show it
    document.querySelector("#totalCoupons").innerHTML = AllCoupons.length;
</script>

<script>
    const allNav = document.getElementById("allNav");
    const rubyNav = document.getElementById("rubyNav");
    const staminaNav = document.getElementById("staminaNav");
    const specialNav = document.getElementById("specialNav");

    allNav.addEventListener("click", () => {
        allNav.classList.add("active");
        rubyNav.classList.remove("active");
        staminaNav.classList.remove("active");
        specialNav.classList.remove("active");
    })

    rubyNav.addEventListener("click", () => {
        allNav.classList.remove("active");
        rubyNav.classList.add("active");
        staminaNav.classList.remove("active");
        specialNav.classList.remove("active");
    })

    staminaNav.addEventListener("click", () => {
        allNav.classList.remove("active");
        rubyNav.classList.remove("active");
        staminaNav.classList.add("active");
        specialNav.classList.remove("active");
    })

    specialNav.addEventListener("click", () => {
        allNav.classList.remove("active");
        rubyNav.classList.remove("active");
        staminaNav.classList.remove("active");
        specialNav.classList.add("active");
    })
</script>

</html>